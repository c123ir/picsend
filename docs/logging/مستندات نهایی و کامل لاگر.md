# راهنمای جامع سیستم لاگینگ پیک‌سند

## فهرست مطالب
1. [مقدمه](#مقدمه)
2. [معماری سیستم](#معماری-سیستم)
3. [نصب و راه‌اندازی](#نصب-و-راه‌اندازی)
4. [استفاده از کلاینت لاگینگ](#استفاده-از-کلاینت-لاگینگ)
5. [داشبورد مدیریت لاگ‌ها](#داشبورد-مدیریت-لاگ‌ها)
6. [API سرور لاگینگ](#api-سرور-لاگینگ)
7. [عیب‌یابی متداول](#عیب‌یابی-متداول)
8. [بهینه‌سازی و مقیاس‌پذیری](#بهینه‌سازی-و-مقیاس‌پذیری)

---

## مقدمه

سیستم لاگینگ پیک‌سند یک راهکار جامع برای ثبت، نمایش و تحلیل رویدادهای برنامه است. این سیستم به توسعه‌دهندگان و مدیران سیستم کمک می‌کند تا:

- خطاها و مشکلات را به سرعت شناسایی و رفع کنند
- روندهای برنامه را تحلیل کنند
- عملکرد سیستم را بهبود دهند
- مشکلات امنیتی را شناسایی کنند

سیستم لاگینگ به گونه‌ای طراحی شده که حتی در حالت قطع ارتباط با سرور لاگینگ نیز لاگ‌ها از بین نمی‌روند و پس از برقراری مجدد ارتباط، به سرور منتقل می‌شوند.

---

## معماری سیستم

سیستم لاگینگ پیک‌سند از سه بخش اصلی تشکیل شده است:

1. **کلاینت لاگینگ (LoggingClient)**:
   - یک کتابخانه سمت کلاینت که در برنامه‌های مختلف استفاده می‌شود
   - قابلیت ذخیره‌سازی محلی لاگ‌ها در حالت آفلاین
   - پشتیبانی از سطوح مختلف لاگ (debug, info, warn, error)

2. **سرور لاگینگ (LoggingServer)**:
   - یک سرور Express که لاگ‌ها را دریافت و ذخیره می‌کند
   - ارائه API برای دریافت و فیلتر کردن لاگ‌ها
   - پشتیبانی از ارتباط Socket.IO برای لاگینگ زنده

3. **داشبورد مدیریت لاگ‌ها**:
   - رابط کاربری وب برای مشاهده و مدیریت لاگ‌ها
   - قابلیت‌های فیلتر، جستجو و تحلیل
   - نمودارهای آماری برای درک بهتر وضعیت سیستم

### دیاگرام معماری

```
+----------------+    +-----------------+    +-------------------+
| برنامه‌های     | -> | کلاینت لاگینگ   | -> | ذخیره‌سازی محلی  |
| مختلف         |    |                 |    | (حالت آفلاین)     |
+----------------+    +-----------------+    +-------------------+
                              |                        |
                              v                        |
                    +-----------------+               |
                    | Socket.IO       | <-------------+
                    +-----------------+  (پس از اتصال مجدد)
                              |
                              v
+----------------+    +-----------------+    +-------------------+
| فایل‌های لاگ   | <- | سرور لاگینگ     | <- | دریافت HTTP      |
+----------------+    +-----------------+    +-------------------+
        |                     |                        ^
        v                     v                        |
+----------------+    +-----------------+    +-------------------+
| نمودارها و     | <- | داشبورد مدیریت | <- | کاربران و مدیران  |
| تحلیل‌ها       |    | لاگ‌ها          |    | سیستم            |
+----------------+    +-----------------+    +-------------------+
```

---

## نصب و راه‌اندازی

### پیش‌نیازها

- Node.js نسخه 14 یا بالاتر
- npm یا yarn

### 1. راه‌اندازی سرور لاگینگ

ابتدا از دایرکتوری اصلی پروژه، به پوشه `logger` بروید:

```bash
cd logger
```

نصب وابستگی‌ها:

```bash
npm install
```

اطمینان از وجود پوشه‌های لازم:

```bash
mkdir -p logs src/public
```

کپی کردن فایل‌های داشبورد به پوشه public:
کد HTML که قبلاً ارائه شد را در فایل `src/public/index.html` ذخیره کنید.

راه‌اندازی سرور لاگینگ:

```bash
npm start
```

سرور لاگینگ به صورت پیش‌فرض روی پورت 3015 راه‌اندازی می‌شود.

### 2. تنظیم کلاینت لاگینگ در برنامه اصلی

در پروژه اصلی، فایل `src/utils/loggingClient.ts` را ایجاد یا به‌روزرسانی کنید:

```bash
mkdir -p src/utils
```

کد کلاینت لاگینگ که قبلاً ارائه شد را در فایل `src/utils/loggingClient.ts` ذخیره کنید.

### 3. تنظیم متغیرهای محیطی

در فایل `.env` پروژه اصلی، این خطوط را اضافه یا به‌روزرسانی کنید:

```
# تنظیمات لاگینگ
VITE_LOGGING_SERVER_URL=http://localhost:3015
VITE_LOG_LEVEL=debug
VITE_ENABLE_DEBUG_LOGS=true
```

---

## استفاده از کلاینت لاگینگ

برای استفاده از کلاینت لاگینگ در کامپوننت‌ها یا سرویس‌های مختلف برنامه، ابتدا آن را import کنید:

```typescript
import { loggingClient } from '../utils/loggingClient';
```

### ثبت لاگ با سطوح مختلف

#### سطح Debug

برای اطلاعات جزئی مفید برای عیب‌یابی:

```typescript
loggingClient.debug('پیام دیباگ', { key: 'value' });
```

#### سطح Info

برای اطلاعات عمومی درباره عملکرد برنامه:

```typescript
loggingClient.info('عملیات با موفقیت انجام شد', { userId: 123 });
```

#### سطح Warning

برای هشدارها و مشکلات غیر بحرانی:

```typescript
loggingClient.warn('تعداد تلاش‌ها زیاد است', { attempts: 5, maxAttempts: 10 });
```

#### سطح Error

برای خطاهای برنامه که نیاز به توجه دارند:

```typescript
try {
  // کد دارای خطا
} catch (error) {
  loggingClient.error('خطا در پردازش درخواست', { 
    error: error.message,
    stack: error.stack,
    requestId: '12345'
  });
}
```

### ثبت لاگ‌های عملکردی

برای ثبت زمان اجرای عملیات‌ها:

```typescript
const startTime = performance.now();

// عملیات مورد نظر
await fetchData();

const duration = performance.now() - startTime;
loggingClient.logPerformance('دریافت داده‌ها', duration);
```

### نمونه استفاده در یک کامپوننت React

```tsx
import React, { useEffect, useState } from 'react';
import { loggingClient } from '../utils/loggingClient';

const UserProfile: React.FC = () => {
  const [user, setUser] = useState(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);

  useEffect(() => {
    const fetchUser = async () => {
      try {
        loggingClient.info('شروع دریافت اطلاعات کاربر');
        
        const startTime = performance.now();
        const response = await fetch('/api/user/profile');
        
        if (!response.ok) {
          throw new Error(`خطای ${response.status}: ${response.statusText}`);
        }
        
        const userData = await response.json();
        setUser(userData);
        
        const duration = performance.now() - startTime;
        loggingClient.logPerformance('دریافت اطلاعات کاربر', duration);
        loggingClient.info('اطلاعات کاربر با موفقیت دریافت شد', { userId: userData.id });
      } catch (err) {
        setError(err.message);
        loggingClient.error('خطا در دریافت اطلاعات کاربر', { 
          error: err.message, 
          stack: err.stack 
        });
      } finally {
        setLoading(false);
      }
    };

    fetchUser();
  }, []);

  // ادامه کامپوننت...
};
```

---

## داشبورد مدیریت لاگ‌ها

داشبورد مدیریت لاگ‌ها یک رابط کاربری وب برای مشاهده و تحلیل لاگ‌هاست که به صورت خودکار با سرور لاگینگ ارائه می‌شود.

### دسترسی به داشبورد

پس از راه‌اندازی سرور لاگینگ، می‌توانید با مراجعه به آدرس زیر به داشبورد دسترسی پیدا کنید:

```
http://localhost:3015
```

### ویژگی‌های داشبورد

#### 1. بخش لاگ‌ها

- **مشاهده لاگ‌ها**: نمایش لاگ‌ها با جزئیات (زمان، سطح، سرویس، پیام)
- **فیلتر سطح**: امکان فیلتر کردن بر اساس سطح لاگ (error, warn, info, debug)
- **فیلتر سرویس**: فیلتر کردن بر اساس منبع لاگ
- **جستجو**: جستجو در پیام‌ها و جزئیات لاگ‌ها
- **بازه زمانی**: انتخاب بازه زمانی برای نمایش لاگ‌ها (30 دقیقه تا 7 روز)
- **بروزرسانی زنده**: نمایش لاگ‌های جدید به صورت زنده
- **جزئیات لاگ**: نمایش متادیتا و اطلاعات کامل هر لاگ
- **خروجی JSON**: دریافت فایل JSON از لاگ‌های فیلتر شده

#### 2. بخش تحلیل

- **نمودار روند**: نمایش تعداد لاگ‌ها در هر ساعت به تفکیک سطح
- **نمودار توزیع سطوح**: نمایش نسبت سطوح لاگ به صورت دایره‌ای
- **نمودار توزیع منابع**: نمایش تعداد لاگ‌ها به تفکیک منبع
- **خطاهای اخیر**: نمایش 10 خطای اخیر سیستم

#### 3. بخش زمان‌بندی

- **توالی زمانی**: نمایش لاگ‌ها به ترتیب زمان وقوع با نمایش گرافیکی
- **بازه‌های مختلف**: امکان انتخاب بازه‌های زمانی مختلف

### استفاده از داشبورد

#### فیلتر کردن لاگ‌ها

1. از بخش "سطح لاگ" در سمت راست، سطوح مورد نظر را انتخاب کنید
2. از منوی کشویی "سرویس" می‌توانید منبع لاگ‌ها را فیلتر کنید
3. در فیلد جستجو می‌توانید متنی را جستجو کنید
4. از منوی "بازه زمانی" می‌توانید محدوده زمانی لاگ‌ها را مشخص کنید

#### مشاهده جزئیات لاگ

روی هر لاگ کلیک کنید یا روی دکمه جزئیات (آیکون اطلاعات) در سمت راست هر ردیف کلیک کنید تا جزئیات کامل لاگ را مشاهده کنید.

#### خروجی گرفتن

برای دریافت خروجی JSON از لاگ‌های فیلتر شده فعلی، روی دکمه "خروجی JSON" کلیک کنید.

#### تحلیل داده‌ها

1. روی تب "تحلیل" در بالای صفحه کلیک کنید
2. نمودارهای مختلف را بررسی کنید
3. برای بروزرسانی نمودارها، روی دکمه "بروزرسانی" کلیک کنید

#### مشاهده زمان‌بندی

1. روی تب "زمان‌بندی" در بالای صفحه کلیک کنید
2. لاگ‌ها را به ترتیب زمانی مشاهده کنید
3. با استفاده از منوی کشویی بالای صفحه، بازه زمانی را تغییر دهید

---

## API سرور لاگینگ

سرور لاگینگ API‌های زیر را ارائه می‌دهد:

### 1. ثبت لاگ جدید

```
POST /logs
```

پارامترهای درخواست:
```json
{
  "level": "error | warn | info | debug",
  "message": "پیام لاگ",
  "source": "نام سرویس",
  "metadata": { 
    "key1": "value1",
    "key2": "value2"
  }
}
```

پاسخ موفق:
```json
{
  "success": true,
  "data": {
    "level": "error",
    "message": "پیام لاگ",
    "source": "نام سرویس",
    "metadata": { "key1": "value1" },
    "timestamp": "2025-03-14T11:20:41.123Z"
  }
}
```

### 2. دریافت لاگ‌ها

```
GET /api/logs
```

پارامترهای Query:
- `timeRange`: بازه زمانی (مثال: `30m`, `1h`, `24h`, `7d`)
- `levels`: سطوح لاگ، با کاما جدا شده (مثال: `error,warn`)
- `source`: فیلتر براساس منبع
- `search`: جستجو در پیام‌ها

پاسخ موفق:
```json
{
  "success": true,
  "data": [
    {
      "level": "error",
      "message": "خطا در پردازش درخواست",
      "source": "api-gateway",
      "metadata": { "requestId": "12345" },
      "timestamp": "2025-03-14T11:20:41.123Z"
    },
    ...
  ],
  "totalCount": 100,
  "filteredCount": 25
}
```

### 3. دریافت لیست سرویس‌ها

```
GET /api/logs/sources
```

پاسخ موفق:
```json
{
  "success": true,
  "data": ["client-3005", "server-3010", "auth-service"]
}
```

### 4. دریافت آمار لاگ‌ها

```
GET /api/logs/stats
```

پارامترهای Query:
- `timeRange`: بازه زمانی (مثال: `24h`)

پاسخ موفق:
```json
{
  "success": true,
  "data": {
    "total": 1250,
    "byLevel": {
      "error": 45,
      "warn": 120,
      "info": 800,
      "debug": 285
    },
    "bySources": {
      "client-3005": 500,
      "server-3010": 750
    }
  }
}
```

### 5. دریافت خروجی JSON

```
GET /api/logs/export
```

پارامترهای Query: مشابه API دریافت لاگ‌ها

پاسخ: فایل JSON قابل دانلود

---

## عیب‌یابی متداول

### 1. لاگ‌ها در داشبورد نمایش داده نمی‌شوند

**علت احتمالی 1**: سرور لاگینگ در حال اجرا نیست.
- **راه‌حل**: اطمینان حاصل کنید که سرور لاگینگ در حال اجراست:
  ```bash
  cd logger
  npm start
  ```

**علت احتمالی 2**: آدرس سرور لاگینگ در تنظیمات اشتباه است.
- **راه‌حل**: مقدار `VITE_LOGGING_SERVER_URL` در فایل `.env` را بررسی کنید.

**علت احتمالی 3**: مشکل در اتصال Socket.IO.
- **راه‌حل**: کنسول مرورگر را بررسی کنید و از باز بودن پورت 3015 اطمینان حاصل کنید.

### 2. لاگ‌ها در حالت آفلاین ذخیره نمی‌شوند

**علت احتمالی**: مشکل در دسترسی به localStorage.
- **راه‌حل**: بررسی کنید که localStorage در مرورگر فعال باشد و فضای کافی داشته باشد.

### 3. خطای CORS در داشبورد

**علت احتمالی**: تنظیمات CORS در سرور لاگینگ.
- **راه‌حل**: مطمئن شوید که origin مناسب در تنظیمات CORS سرور لاگینگ تعریف شده است.

### 4. عملکرد کند داشبورد

**علت احتمالی**: تعداد زیاد لاگ‌ها در بازه زمانی انتخاب شده.
- **راه‌حل**: بازه زمانی کوتاه‌تری انتخاب کنید یا فیلترهای بیشتری اعمال کنید.

---

## بهینه‌سازی و مقیاس‌پذیری

### مدیریت حجم لاگ‌ها

برای مدیریت بهتر حجم لاگ‌ها:

1. **تنظیم سطح لاگینگ**: در محیط تولید، `VITE_LOG_LEVEL` را به `info` یا `warn` تغییر دهید تا حجم لاگ‌ها کاهش یابد.

2. **چرخش خودکار فایل‌ها**: سرور لاگینگ به صورت خودکار فایل‌ها را بر اساس تاریخ ذخیره می‌کند تا مدیریت آنها ساده‌تر باشد.

3. **پاکسازی دوره‌ای**: برای پاکسازی خودکار لاگ‌های قدیمی، می‌توانید یک اسکریپت یا cron job ایجاد کنید:

   ```bash
   #!/bin/bash
   # پاک کردن لاگ‌های قدیمی‌تر از 30 روز
   find /path/to/logger/logs -type f -name "*.log" -mtime +30 -delete
   ```

### مقیاس‌پذیری برای سیستم‌های بزرگ

برای سیستم‌های با حجم بالای لاگ:

1. **پایگاه داده**: بجای ذخیره در فایل، از یک پایگاه داده مانند MongoDB یا Elasticsearch استفاده کنید:

   ```javascript
   // نمونه اتصال به MongoDB
   const mongoose = require('mongoose');
   mongoose.connect('mongodb://localhost/logs');
   
   const LogSchema = new mongoose.Schema({
     level: String,
     message: String,
     source: String,
     metadata: Object,
     timestamp: { type: Date, default: Date.now }
   });
   
   const Log = mongoose.model('Log', LogSchema);
   ```

2. **تقسیم‌بندی سرویس‌ها**: برای هر سرویس یا گروه سرویس، یک نمونه مجزا از سرور لاگینگ راه‌اندازی کنید.

3. **استفاده از کافکا یا RabbitMQ**: برای مدیریت حجم بالای لاگ، از یک سیستم صف‌بندی استفاده کنید:

   ```javascript
   // نمونه استفاده از کافکا
   const { Kafka } = require('kafkajs');
   
   const kafka = new Kafka({
     clientId: 'logging-service',
     brokers: ['localhost:9092']
   });
   
   const producer = kafka.producer();
   await producer.connect();
   
   // ارسال لاگ به کافکا
   await producer.send({
     topic: 'logs',
     messages: [
       { value: JSON.stringify(log) }
     ]
   });
   ```

### ادغام با سیستم‌های دیگر

سیستم لاگینگ را می‌توان با سیستم‌های دیگر ادغام کرد:

1. **سیستم هشدار**: ارسال هشدار در صورت وقوع خطاهای خاص:

   ```javascript
   // نمونه اتصال به سیستم هشدار
   function alertOnCriticalError(log) {
     if (log.level === 'error' && log.metadata?.critical) {
       sendAlert({
         title: `خطای بحرانی: ${log.message}`,
         details: log,
         priority: 'high'
       });
     }
   }
   ```

2. **سیستم مانیتورینگ**: ارسال داده‌های آماری به سرویس‌های مانیتورینگ مانند Prometheus یا Grafana.

3. **سرویس‌های تحلیلی**: ارسال لاگ‌ها به سرویس‌های تحلیل داده برای بررسی‌های پیشرفته‌تر.

---

این راهنما، اطلاعات کامل درباره نحوه استفاده از سیستم لاگینگ پیک‌سند را ارائه می‌دهد. با استفاده از این سیستم، می‌توانید به راحتی رویدادهای برنامه را ثبت، مشاهده و تحلیل کنید.

برای سوالات بیشتر یا مشکلات احتمالی، به بخش [عیب‌یابی متداول](#عیب‌یابی-متداول) مراجعه کنید یا با تیم پشتیبانی تماس بگیرید.
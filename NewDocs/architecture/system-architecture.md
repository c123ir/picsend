# معماری سیستم PicSend

<div dir="rtl">

این سند معماری سیستم PicSend را به تفصیل توضیح می‌دهد. هدف از این سند، ارائه یک دید کلی از کامپوننت‌های سیستم، ارتباط بین آن‌ها و استراتژی‌های طراحی است.

## معماری کلی

PicSend یک سیستم توزیع‌شده است که از سه بخش اصلی تشکیل شده است:

1. **کلاینت**: اپلیکیشن وب مبتنی بر React
2. **سرور اصلی**: سرویس بک‌اند مبتنی بر Node.js و Express
3. **سرویس لاگینگ**: سرویس مستقل مدیریت لاگ

### نمودار معماری

```
+---------------+       +---------------+       +---------------+
|               |       |               |       |               |
|    کلاینت     |<----->|  سرور اصلی   |<----->|   دیتابیس     |
|    (React)    |       |   (Node.js)   |       |    (MySQL)    |
|               |       |               |       |               |
+---------------+       +-------+-------+       +---------------+
                                |
                                |
                                v
                        +---------------+
                        |               |
                        | سرویس لاگینگ  |
                        |   (Node.js)   |
                        |               |
                        +-------+-------+
                                |
                                |
                                v
                        +---------------+
                        |               |
                        | دیتابیس لاگ   |
                        |    (MySQL)    |
                        |               |
                        +---------------+
```

## معماری کلاینت

کلاینت با استفاده از React، TypeScript و Vite ساخته شده است و با استفاده از یک معماری کامپوننت‌محور طراحی شده است.

### ساختار لایه‌های کلاینت

```
+---------------------+
|       Pages         |
+---------------------+
|     Components      |
+---------------------+
|    Context API      |
+---------------------+
|     Services        |
+---------------------+
|   HTTP Client       |
+---------------------+
```

### کامپوننت‌های کلیدی

1. **Context API**: مدیریت حالت اپلیکیشن را با استفاده از Context API ریکت انجام می‌دهد.
   - `AuthContext`: مدیریت وضعیت احراز هویت کاربر
   - `ThemeContext`: مدیریت تم و ظاهر اپلیکیشن

2. **خدمات (Services)**:
   - `authService`: مدیریت API های احراز هویت
   - `userService`: مدیریت API های کاربران
   - `smsService`: ارتباط با سرویس پیامک

3. **کامپوننت‌های اصلی**:
   - `LoginForm`: فرم ورود با پشتیبانی از احراز هویت با نام کاربری یا شماره موبایل
   - `OTPInput`: کامپوننت ورود کد تأیید
   - `UserProfile`: نمایش و ویرایش اطلاعات کاربر

## معماری سرور اصلی

سرور اصلی با استفاده از Node.js، Express و TypeScript پیاده‌سازی شده است و از یک معماری لایه‌بندی شده استفاده می‌کند.

### ساختار لایه‌های سرور

```
+---------------------+
|       Routes        |
+---------------------+
|    Controllers      |
+---------------------+
|     Services        |
+---------------------+
|      Models         |
+---------------------+
|     Database        |
+---------------------+
```

### کامپوننت‌های کلیدی

1. **Routes**: تعریف API endpoints و مسیریابی درخواست‌ها
   - `authRoutes`: مسیرهای احراز هویت (ورود، ثبت‌نام)
   - `userRoutes`: مسیرهای مدیریت کاربران

2. **Controllers**: منطق کنترل جریان درخواست‌ها
   - `authController`: کنترل‌کننده عملیات احراز هویت
   - `userController`: کنترل‌کننده عملیات مرتبط با کاربران

3. **Models**: تعریف مدل‌های داده با استفاده از Sequelize
   - `User`: مدل کاربر
   - `VerificationCode`: مدل کدهای تأیید

4. **Middleware**: میان‌افزارهای پردازش درخواست‌ها
   - `auth`: بررسی اعتبار توکن JWT
   - `errorHandler`: مدیریت متمرکز خطاها
   - `logger`: ثبت لاگ درخواست‌ها

## معماری سرویس لاگینگ

سرویس لاگینگ یک میکروسرویس مستقل است که با استفاده از Node.js، Express و TypeScript پیاده‌سازی شده است.

### ساختار لایه‌های سرویس لاگینگ

```
+---------------------+
|       Routes        |
+---------------------+
|     Controllers     |
+---------------------+
|      Services       |
+---------------------+
|       Models        |
+---------------------+
|      Database       |
+---------------------+
```

### کامپوننت‌های کلیدی

1. **REST API**: برای دریافت و ذخیره لاگ‌ها
   - `POST /logs`: دریافت و ثبت لاگ‌ها
   - `GET /logs`: بازیابی لاگ‌ها با فیلترهای مختلف

2. **داشبورد وب**: نمایش و فیلتر لاگ‌ها
   - فیلتر بر اساس سطح لاگ، سرویس و زمان
   - جستجو در متن لاگ‌ها

3. **مکانیزم ذخیره‌سازی دوگانه**:
   - ذخیره در دیتابیس MySQL برای جستجو و فیلتر
   - ذخیره در فایل‌های متنی برای آرشیو و پشتیبان‌گیری

## جریان داده و ارتباطات

### احراز هویت کاربر

1. کاربر نام کاربری و رمز عبور یا شماره موبایل را وارد می‌کند
2. کلاینت درخواست را به `/auth/login` یا `/auth/send-code` ارسال می‌کند
3. سرور اطلاعات را بررسی و در صورت صحت، توکن JWT یا کد تأیید SMS را تولید می‌کند
4. کلاینت با استفاده از توکن، به منابع محافظت‌شده دسترسی پیدا می‌کند

### ثبت و مدیریت لاگ‌ها

1. اجزای مختلف سیستم (کلاینت، سرور اصلی) لاگ‌های خود را به سرویس لاگینگ ارسال می‌کنند
2. سرویس لاگینگ لاگ‌ها را در دیتابیس و فایل ذخیره می‌کند
3. کاربران مجاز می‌توانند از طریق داشبورد وب به لاگ‌ها دسترسی داشته باشند

## مدل توسعه‌پذیری

1. **مقیاس‌پذیری افقی**:
   - امکان اجرای چندین نمونه از سرور اصلی پشت یک لودبالانسر
   - سرویس لاگینگ مستقل که می‌تواند جداگانه مقیاس‌دهی شود

2. **مدل چند‌مستاجری (Multi-tenancy)**:
   - داده‌های کاربران مختلف با استفاده از فیلد `tenantId` از یکدیگر جدا می‌شوند
   - دسترسی به داده‌ها بر اساس فیلد `tenantId` فیلتر می‌شود

## امنیت

1. **احراز هویت**:
   - استفاده از JWT برای تایید هویت کاربران
   - احراز هویت دو مرحله‌ای با استفاده از پیامک

2. **کنترل دسترسی**:
   - RBAC (Role-Based Access Control) برای مدیریت دسترسی‌ها
   - Middleware های امنیتی برای کنترل دسترسی به منابع

3. **امنیت API**:
   - محدودیت نرخ درخواست (Rate Limiting)
   - CORS محدود برای جلوگیری از درخواست‌های Cross-Origin غیرمجاز
   - اعتبارسنجی داده‌های ورودی

## مدل استقرار (Deployment)

سیستم PicSend از یک معماری چند‌لایه برای استقرار پشتیبانی می‌کند:

1. **محیط توسعه**:
   - استقرار محلی با استفاده از Docker Compose
   - دیتابیس‌های جداگانه برای سرور اصلی و سرویس لاگینگ

2. **محیط تولید**:
   - استقرار در زیرساخت ابری (AWS یا معادل‌های داخلی)
   - استفاده از لودبالانسر برای توزیع ترافیک
   - جداسازی کامل سرویس‌ها برای مقیاس‌پذیری بهتر

### نمودار استقرار

```
                +------------------+
                |    Load Balancer |
                +--------+---------+
                         |
          +-----------------------------+
          |              |              |
+---------v--+    +------v------+    +--v---------+
|            |    |             |    |            |
| Web Client |    | Main Server |    | Log Server |
|            |    | Instance(s) |    | Instance(s)|
|            |    |             |    |            |
+------------+    +------+------+    +------+-----+
                         |                  |
                  +------v------+    +------v-----+
                  |             |    |            |
                  |  Main DB    |    |   Log DB   |
                  | (MySQL/HA)  |    | (MySQL/HA) |
                  |             |    |            |
                  +-------------+    +------------+
```

## نتیجه‌گیری

معماری PicSend به گونه‌ای طراحی شده است که مقیاس‌پذیری، قابلیت نگهداری و امنیت را تضمین کند. جداسازی سرویس‌ها (مخصوصاً سرویس لاگینگ) اجازه می‌دهد هر بخش بتواند مستقل مقیاس‌دهی و بروزرسانی شود.

استفاده از فناوری‌های مناسب مانند React برای فرانت‌اند، Node.js و Express برای بک‌اند و Sequelize برای لایه دسترسی به داده، یک پایه قوی برای توسعه بیشتر سیستم فراهم می‌کند.

## منابع تکمیلی

- [نقشه راه توسعه](../roadmap/development-roadmap.md)
- [راه‌اندازی محلی](../deployment/local-setup.md)
- [مستندات API](../api/api-docs.md)

</div> 